{% extends "bootstrap/base.html" %}

{% block title %}DMA | Openlayer {% endblock %}

<!-- head -->
{% block head %}
    {{ super() }}
    <link href="{{ url_for('static',filename='assets/ol3/ol.css') }}" rel="stylesheet">
    <link href="{{ url_for('static',filename='css/sample.css') }}" rel="stylesheet">
    
    <script type="text/javascript">
		var dlzxcUrl = "{{ url_for('main.dlzxc') }}";
	</script>
    
{% endblock %}

  {% block content %}
    <div id="map" class="map"></div>
    <div id="layertree">
      <h5>Click on layer nodes below to change their properties.</h5>
      <ul>
        <li><span>OSM layer</span>
          <fieldset id="layer0">
            <label class="checkbox" for="visible0">
              <input id="visible0" class="visible" type="checkbox"/>visibility
            </label>
            <label>opacity</label>
            <input class="opacity" type="range" min="0" max="1" step="0.01"/>
          </fieldset>
        </li>
        <li><span>Layer group</span>
          <fieldset id="layer1">
            <label class="checkbox" for="visible1">
              <input id="visible1" class="visible" type="checkbox"/>visibility
            </label>
            <label>opacity</label>
            <input class="opacity" type="range" min="0" max="1" step="0.01"/>
          </fieldset>
          <ul>
            <li><span>dlzxc</span>
              <fieldset id="layer10">
                <label class="checkbox" for="visible10">
                  <input id="visible10" class="visible" type="checkbox"/>visibility
                </label>
                <label>opacity</label>
                <input class="opacity" type="range" min="0" max="1" step="0.01"/>
              </fieldset>
            </li>
            <li><span>World borders layer</span>
              <fieldset id="layer11">
                <label class="checkbox" for="visible11">
                  <input id="visible11" class="visible" type="checkbox"/>visibility
                </label>
                <label>opacity</label>
                <input class="opacity" type="range" min="0" max="1" step="0.01"/>
              </fieldset>
            </li>
          </ul>
        </li>
      </ul>
    </div>
   
    <script src="{{ url_for('static',filename='assets/ol3/ol.js') }} "></script>
    <script src="{{ url_for('static',filename='assets/jquery-2.2.4.min.js') }} "></script>
    
    <script>
    
    var image = new ol.style.Circle({
        radius: 5,
        fill: null,
        stroke: new ol.style.Stroke({color: 'red', width: 1})
      });

      var styles = {
        'Point': new ol.style.Style({
          image: image
        }),
        'LineString': new ol.style.Style({
          stroke: new ol.style.Stroke({
            color: 'green',
            width: 1
          })
        }),
        'MultiLineString': new ol.style.Style({
          stroke: new ol.style.Stroke({
            color: 'green',
            width: 1
          })
        }),
        'MultiPoint': new ol.style.Style({
          image: image
        }),
        'MultiPolygon': new ol.style.Style({
          stroke: new ol.style.Stroke({
            color: 'yellow',
            width: 1
          }),
          fill: new ol.style.Fill({
            color: 'rgba(255, 255, 0, 0.1)'
          })
        }),
        'Polygon': new ol.style.Style({
          stroke: new ol.style.Stroke({
            color: 'blue',
            lineDash: [4],
            width: 3
          }),
          fill: new ol.style.Fill({
            color: 'rgba(0, 0, 255, 0.1)'
          })
        }),
        'GeometryCollection': new ol.style.Style({
          stroke: new ol.style.Stroke({
            color: 'magenta',
            width: 2
          }),
          fill: new ol.style.Fill({
            color: 'magenta'
          }),
          image: new ol.style.Circle({
            radius: 10,
            fill: null,
            stroke: new ol.style.Stroke({
              color: 'magenta'
            })
          })
        }),
        'Circle': new ol.style.Style({
          stroke: new ol.style.Stroke({
            color: 'red',
            width: 2
          }),
          fill: new ol.style.Fill({
            color: 'rgba(255,0,0,0.2)'
          })
        })
      };

      var styleFunction = function(feature) {
        return styles[feature.getGeometry().getType()];
      };
      
    var latitude = 118.40;
    var longitude = 29.86;

    var mapMinZoom = 1;
    var mapMaxZoom = 15;
    var mapExtent = [-2.0037508342787E7, -2.0037508342787E7, 2.0037508342787E7, 2.0037508342787E7];

    var map = new ol.Map({
        target: 'map',
        layers: [
            new ol.layer.Tile({
                source: new ol.source.OSM()
            }),
            new ol.layer.Tile({
            extent: ol.proj.transformExtent(mapExtent, 'EPSG:102100', 'EPSG:3857'),
            source: new ol.source.XYZ({
              attributions: 'Tiles Â© USGS, rendered with ' +
                  '<a href="http://www.maptiler.com/">MapTiler</a>',
              //url: 'http://t0.tianditu.com/DataServer?T=cva_w&x={x}&y={y}&l={z}',
              
              urls:['http://t0.tianditu.com/DataServer?T=cva_w&x={x}&y={y}&l={z}',
	        'http://t1.tianditu.com/DataServer?T=cva_w&x={x}&y={y}&l={z}',
			'http://t2.tianditu.com/DataServer?T=cva_w&x={x}&y={y}&l={z}',
			'http://t3.tianditu.com/DataServer?T=cva_w&x={x}&y={y}&l={z}',
			'http://t4.tianditu.com/DataServer?T=cva_w&x={x}&y={y}&l={z}',
			'http://t5.tianditu.com/DataServer?T=cva_w&x={x}&y={y}&l={z}',
			'http://t6.tianditu.com/DataServer?T=cva_w&x={x}&y={y}&l={z}',
			'http://t7.tianditu.com/DataServer?T=cva_w&x={x}&y={y}&l={z}'],
            
              tilePixelRatio: 2, // THIS IS IMPORTANT
              minZoom: mapMinZoom,
              maxZoom: mapMaxZoom
            })
          }),
        ],
        view: new ol.View({
            center: ol.proj.transform([latitude, longitude], 'EPSG:4326', 'EPSG:3857'),
            zoom: 12
            // maxZoom: 17
        })
    });
    var view = map.getView();
    
    var geoJSONFormat = new ol.format.GeoJSON({
		'defaultDataProjection': 'EPSG:4326' // view.getProjection()
	});
    
    //var source = new ol.source.GeoJSON({
	//	projection: view.getProjection()
	//});

    var source = new ol.source.Vector({
      features: (new ol.format.GeoJSON())
    });
    

    var dlzxc_layer = new ol.layer.Vector({
        title:'dlzxc',
        source: source,
        style: styleFunction
    });
    
    map.addLayer(dlzxc_layer);
    
    $.ajax({
		url: '/geom/g_cloudlayer_meta_sx_qdzdt_map_layer/',
		type: 'GET',
		dataType: 'json',
		contentType: 'application/json',
		mimeType: 'application/json',
		success: function (data) {
            //alert(data.result);
			var features = geoJSONFormat.readFeatures(data.result);
            
			//console.log(features);
			source.addFeatures(features);
		},
		error: function (data, status, er) {
            console.log(data.result);
			console.log(er);
            //alert(er);
		}
	});
    map.addLayer(dlzxc_layer);
    
    function bindInputs(layerid, layer) {
        var visibilityInput = $(layerid + ' input.visible');
        visibilityInput.on('change', function() {
          layer.setVisible(this.checked);
        });
        visibilityInput.prop('checked', layer.getVisible());

        var opacityInput = $(layerid + ' input.opacity');
        opacityInput.on('input change', function() {
          layer.setOpacity(parseFloat(this.value));
        });
        opacityInput.val(String(layer.getOpacity()));
      }
      map.getLayers().forEach(function(layer, i) {
        bindInputs('#layer' + i, layer);
        if (layer instanceof ol.layer.Group) {
          layer.getLayers().forEach(function(sublayer, j) {
            bindInputs('#layer' + i + j, sublayer);
          });
        }
      });

      $('#layertree li > span').click(function() {
        $(this).siblings('fieldset').toggle();
      }).siblings('fieldset').hide();
      
      
    </script>
    
    {% endblock %}
